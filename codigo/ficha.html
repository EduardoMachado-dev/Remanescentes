<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem - RPG Remanescentes</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --cor-fundo: rgba(34, 17, 0, 0.7);
            --cor-destaque: rgba(51, 34, 17, 0.8);
            --cor-botao: #a67c52;
            --cor-botao-hover: #c89f72;
            --cor-borda: #c4a484;
            --cor-texto: #fdf6e3;
            --cor-perigo: #8b0000;
            --cor-sucesso: #4CAF50;
        }
        
        body {
            font-family: 'Georgia', serif;
            background: url('https://i.imgur.com/3ZA1sKc.jpeg') no-repeat center center fixed;
            background-size: cover;
            color: var(--cor-texto);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: var(--cor-destaque);
            padding: 15px;
            border-radius: 8px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        h1, h2 {
            background-color: var(--cor-destaque);
            padding: 10px;
            border-radius: 8px;
            margin-top: 0;
        }
        
        h3 {
            color: var(--cor-texto);
            margin: 15px 0 10px 0;
        }
        
        label, table {
            background-color: var(--cor-fundo);
            padding: 10px;
            border-radius: 8px;
            display: block;
            margin-bottom: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        th, td {
            border: 1px solid var(--cor-borda);
            padding: 8px;
            text-align: center;
        }
        
        th {
            background-color: var(--cor-destaque);
            font-weight: bold;
        }
        
        input, textarea, button, select {
            margin: 5px;
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-family: 'Georgia', serif;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        input[type="number"] {
            width: 80px;
        }
        
        textarea {
            width: 100%;
            box-sizing: border-box;
            resize: vertical;
        }
        
        button {
            background-color: var(--cor-botao);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            padding: 10px 15px;
            border: none;
            font-weight: bold;
        }
        
        button:hover {
            background-color: var(--cor-botao-hover);
        }
        
        .btn-danger {
            background-color: var(--cor-perigo);
        }
        
        .btn-danger:hover {
            background-color: #a52a2a;
        }
        
        .btn-success {
            background-color: var(--cor-sucesso);
        }
        
        .btn-success:hover {
            background-color: #45a049;
        }
        
        .section {
            margin-bottom: 25px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--cor-borda);
        }
        
        .attribute-total {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--cor-botao-hover);
        }
        
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--cor-sucesso);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        
        .sync-status.show {
            display: flex;
        }
        
        .sync-status.error {
            background-color: var(--cor-perigo);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Botões de rolagem integrados */
        .roll-btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .roll-btn:hover {
            background: linear-gradient(145deg, #5CBF60, #4CAF50);
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .roll-btn:active {
            transform: scale(0.95);
            animation: rollShake 0.3s ease-in-out;
        }

        /* Resultado da rolagem */
        .roll-result {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, var(--cor-destaque), var(--cor-fundo));
            border: 3px solid var(--cor-borda);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            z-index: 1000;
            display: none;
            animation: slideInRight 0.5s ease-out;
        }

        .roll-result.show {
            display: block;
        }

        .roll-result.critico-sucesso {
            background: linear-gradient(145deg, #FFD700, #ffed4e);
            color: #333;
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .roll-result.critico-falha {
            background: linear-gradient(145deg, #8b0000, #ff4444);
            color: white;
            border-color: #8b0000;
            animation: rollShake 1s ease-in-out;
        }

        .roll-result.sucesso {
            background: linear-gradient(145deg, #4CAF50, #66bb6a);
            color: white;
            border-color: #4CAF50;
        }

        .roll-result-numero {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .roll-result-detalhes {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .roll-result-calculo {
            text-align: center;
            font-size: 0.9em;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 10px;
        }

        /* Histórico mini */
        .mini-historico {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--cor-fundo);
            border: 2px solid var(--cor-borda);
            border-radius: 10px;
            padding: 15px;
            max-width: 250px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 999;
            display: none;
        }

        .mini-historico.show {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }

        .mini-historico-item {
            padding: 5px;
            border-bottom: 1px solid var(--cor-borda);
            font-size: 0.9em;
        }

        .mini-historico-item:last-child {
            border-bottom: none;
        }

        /* Botões para tabelas expansíveis */
        .add-row-btn {
            background-color: var(--cor-sucesso);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
        }

        .add-row-btn:hover {
            background-color: #45a049;
        }

        .remove-row-btn {
            background-color: var(--cor-perigo);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-row-btn:hover {
            background-color: #a52a2a;
        }

        /* Sistema de peso */
        .peso-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .peso-normal {
            background-color: var(--cor-sucesso);
            color: white;
        }

        .peso-sobrecarregado {
            background-color: #ff9800;
            color: white;
        }

        .peso-maximo {
            background-color: var(--cor-perigo);
            color: white;
        }

        /* Animações */
        @keyframes rollShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .two-columns {
                grid-template-columns: 1fr;
            }
            
            input[type="number"] {
                width: 100%;
            }

            .roll-result {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            .mini-historico {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Modal para dados personalizados */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.modal-overlay.show {
    display: flex;
}

.modal-content {
    background: linear-gradient(145deg, var(--cor-destaque), var(--cor-fundo));
    border: 3px solid var(--cor-borda);
    border-radius: 15px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    color: var(--cor-texto);
    position: relative;
    animation: modalAppear 0.3s ease-out;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--cor-borda);
    padding-bottom: 10px;
}

.modal-close {
    background: none;
    border: none;
    color: var(--cor-texto);
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.modal-close:hover {
    background-color: var(--cor-perigo);
}

.dado-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 10px;
    margin: 20px 0;
}

.dado-preset {
    background: linear-gradient(145deg, var(--cor-botao), var(--cor-botao-hover));
    border: none;
    padding: 15px 10px;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1.1em;
}

.dado-preset:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.input-group {
    display: flex;
    gap: 10px;
    align-items: center;
    margin: 15px 0;
    flex-wrap: wrap;
}

.input-group label {
    background: none;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: bold;
}

.input-group input {
    width: 80px;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@media (max-width: 768px) {
    .modal-content {
        margin: 20px;
        padding: 20px;
    }
    
    .dado-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .input-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .input-group label {
        justify-content: space-between;
    }
}

/* ===== SISTEMA DE CHAT ===== */
.chat-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 350px;
    height: 400px;
    background: linear-gradient(145deg, var(--cor-destaque), var(--cor-fundo));
    border: 3px solid var(--cor-borda);
    border-radius: 15px;
    z-index: 1500;
    display: none;
    flex-direction: column;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
}

.chat-container.show {
    display: flex;
}

.chat-header {
    background: var(--cor-destaque);
    padding: 12px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--cor-borda);
}

.chat-title {
    font-weight: bold;
    color: var(--cor-texto);
    font-size: 1.1em;
}

.chat-toggle {
    background: none;
    border: none;
    color: var(--cor-texto);
    font-size: 18px;
    cursor: pointer;
    padding: 5px;
    border-radius: 3px;
    transition: background-color 0.2s;
}

.chat-toggle:hover {
    background-color: rgba(255,255,255,0.1);
}

.chat-messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    max-height: 280px;
    scrollbar-width: thin;
    scrollbar-color: var(--cor-botao) transparent;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--cor-botao);
    border-radius: 3px;
}

.chat-message {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 8px;
    word-wrap: break-word;
    animation: messageSlide 0.3s ease-out;
}

.chat-message.own {
    background: rgba(76, 175, 80, 0.2);
    border-left: 3px solid var(--cor-sucesso);
    margin-left: 20px;
}

.chat-message.other {
    background: rgba(255, 255, 255, 0.1);
    border-left: 3px solid var(--cor-botao);
    margin-right: 20px;
}

.chat-message.master {
    background: rgba(255, 215, 0, 0.2);
    border-left: 3px solid #FFD700;
    margin-right: 20px;
}

.chat-message.system {
    background: rgba(128, 128, 128, 0.2);
    border-left: 3px solid #808080;
    font-style: italic;
    text-align: center;
    margin: 5px 10px;
}

.chat-message.dice {
    background: rgba(255, 140, 0, 0.2);
    border-left: 3px solid #FF8C00;
    margin-right: 20px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    font-size: 0.9em;
}

.message-user {
    font-weight: bold;
    color: var(--cor-botao-hover);
}

.message-user.master {
    color: #FFD700;
}

.message-user.own {
    color: var(--cor-sucesso);
}

.message-time {
    font-size: 0.8em;
    opacity: 0.7;
}

.message-text {
    color: var(--cor-texto);
    line-height: 1.4;
}

.chat-input-container {
    padding: 10px;
    border-top: 1px solid var(--cor-borda);
    background: var(--cor-fundo);
    border-radius: 0 0 12px 12px;
}

.chat-input-group {
    display: flex;
    gap: 8px;
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--cor-borda);
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-family: 'Georgia', serif;
    font-size: 14px;
}

.chat-input:focus {
    outline: none;
    border-color: var(--cor-botao);
    box-shadow: 0 0 5px rgba(166, 124, 82, 0.3);
}

.chat-send {
    background: var(--cor-sucesso);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.chat-send:hover {
    background: #45a049;
    transform: scale(1.1);
}

.chat-toggle-btn {
    position: fixed;
    bottom: 80px;
    left: 20px;
    background: var(--cor-destaque);
    border: 2px solid var(--cor-borda);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    color: var(--cor-texto);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1400;
    transition: all 0.3s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
}

.chat-toggle-btn:hover {
    transform: scale(1.1);
    background: var(--cor-botao);
}

.chat-toggle-btn.has-notification {
    animation: chatPulse 2s infinite;
}

.online-indicator {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--cor-sucesso);
    border: 2px solid white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 10px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes chatPulse {
    0%, 100% { box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 3px 20px rgba(76, 175, 80, 0.6); }
}

@media (max-width: 768px) {
    .chat-container {
        width: calc(100vw - 40px);
        left: 20px;
        right: 20px;
        height: 350px;
    }
    
    .chat-toggle-btn {
        width: 50px;
        height: 50px;
        bottom: 70px;
    }
}

    </style>
</head>
<body>

<div class="container">
    <header>
        <button onclick="voltarAoHub()" class="btn-danger">← Voltar ao Hub</button>
        <h1 id="tituloFicha">Ficha de Personagem - RPG Remanescentes</h1>
        <div class="header-actions">
            <button onclick="rolarIniciativa()" class="btn-success" title="Rolar Iniciativa">⚡ Init</button>
            <button onclick="rolarAtaque()" class="btn-success" title="Rolar Ataque">⚔️ Ataque</button>
            <button onclick="rolarDano('1d6')" class="btn-success" title="Rolar Dano">💥 1d6</button>
            <button onclick="abrirDadoPersonalizado()" class="btn-success" title="Dado Personalizado">🎯 Personalizado</button>
            <button onclick="toggleMiniHistorico()" class="btn-success" title="Histórico">📜</button>
            <button onclick="salvarFicha()" class="btn-success">💾 Salvar</button>
            <button onclick="exportarFicha()">📥 Exportar</button>
            <button onclick="compartilharFicha()">🔗 Compartilhar</button>
            <button onclick="abrirRegras()">📚 Regras</button>
            <button onclick="logout()" class="btn-danger">Sair</button>
        </div>
    </header>

    <!-- Status de sincronização -->
    <div id="syncStatus" class="sync-status">
        <span id="syncText">Salvando...</span>
    </div>

    <div class="section">
        <h2>1. Informações Básicas</h2>
        <div class="two-columns">
            <label>Nome: <input type="text" id="nome" placeholder="Nome do personagem" onchange="autoSave()"></label>
            <label>Jogador: <input type="text" id="jogador" placeholder="Nome do jogador" onchange="autoSave()"></label>
            <label>Raça: <input type="text" id="raca" placeholder="Raça do personagem" onchange="autoSave()"></label>
            <label>Tribo/Reino: <input type="text" id="tribo" placeholder="Origem" onchange="autoSave()"></label>
            <label>Classe: <input type="text" id="classe" placeholder="Classe do personagem" onchange="autoSave()"></label>
            <label>Nível: <input type="number" id="nivel" value="1" min="1" max="20" onchange="atualizarTotais(); autoSave()"></label>
            <label>Experiência: <input type="number" id="xp" value="0" min="0" onchange="autoSave()"></label>
        </div>
    </div>

    <div class="section">
        <h2>2. Atributos Primários</h2>
        <table>
            <tr>
                <th>Atributo</th><th>Base</th><th>Bônus</th><th>Mod</th><th>Total</th><th>Teste</th>
            </tr>
            <tr>
                <td><strong>FOR</strong></td>
                <td><input type="number" id="for_base" value="1" min="1" max="20" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="for_bonus" value="0" min="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="for_mod" value="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><span id="for_total" class="attribute-total">1</span></td>
                <td><button class="roll-btn" onclick="rolarAtributo('for')" title="Rolar teste de Força">🎲</button></td>
            </tr>
            <tr>
                <td><strong>DES</strong></td>
                <td><input type="number" id="des_base" value="1" min="1" max="20" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="des_bonus" value="0" min="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="des_mod" value="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><span id="des_total" class="attribute-total">1</span></td>
                <td><button class="roll-btn" onclick="rolarAtributo('des')" title="Rolar teste de Destreza">🎲</button></td>
            </tr>
            <tr>
                <td><strong>CON</strong></td>
                <td><input type="number" id="con_base" value="1" min="1" max="20" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="con_bonus" value="0" min="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="con_mod" value="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><span id="con_total" class="attribute-total">1</span></td>
                <td><button class="roll-btn" onclick="rolarAtributo('con')" title="Rolar teste de Constituição">🎲</button></td>
            </tr>
            <tr>
                <td><strong>INT</strong></td>
                <td><input type="number" id="int_base" value="1" min="1" max="20" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="int_bonus" value="0" min="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="int_mod" value="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><span id="int_total" class="attribute-total">1</span></td>
                <td><button class="roll-btn" onclick="rolarAtributo('int')" title="Rolar teste de Inteligência">🎲</button></td>
            </tr>
            <tr>
                <td><strong>CAR</strong></td>
                <td><input type="number" id="car_base" value="1" min="1" max="20" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="car_bonus" value="0" min="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><input type="number" id="car_mod" value="0" onchange="atualizarTotais(); autoSave()"></td>
                <td><span id="car_total" class="attribute-total">1</span></td>
                <td><button class="roll-btn" onclick="rolarAtributo('car')" title="Rolar teste de Carisma">🎲</button></td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>3. Recursos</h2>
        <div class="two-columns">
            <label>Vida Máxima: <span id="vida_max" class="attribute-total">0</span></label>
            <label>Vida Atual: <input type="number" id="vida_atual" value="0" min="0" onchange="validarVidaAtual(); autoSave()"></label>
            <label>Defesa: <span id="defesa" class="attribute-total">0</span></label>
            <label>Mana Máxima: <span id="mana_max" class="attribute-total">0</span></label>
            <label>Mana Atual: <input type="number" id="mana_atual" value="0" min="0" onchange="validarManaAtual(); autoSave()"></label>
            <label>Pontos de Esforço: <span id="esforco_max" class="attribute-total">0</span></label>
            <label>Esforço Atual: <input type="number" id="esforco_atual" value="0" min="0" onchange="validarEsforcoAtual(); autoSave()"></label>
        </div>
    </div>

    <div class="section">
        <h2>Configurações de Recursos</h2>
        <div class="two-columns">
            <div>
                <h3>Vida</h3>
                <label>Vida por Nível: <input type="number" id="hp_per_level" value="5" min="0" onchange="calcularRecursos(); autoSave()"></label>
                <label>Bônus Vida da Raça: <input type="number" id="race_hp_bonus" value="0" min="0" onchange="calcularRecursos(); autoSave()"></label>
                <label>Bônus Vida da Classe: <input type="number" id="class_hp_bonus" value="0" min="0" onchange="calcularRecursos(); autoSave()"></label>
            </div>
            <div>
                <h3>Mana</h3>
                <label>Mana por Nível: <input type="number" id="mana_per_level" value="3" min="0" onchange="calcularRecursos(); autoSave()"></label>
                <label>Bônus Mana da Raça: <input type="number" id="race_mana_bonus" value="0" min="0" onchange="calcularRecursos(); autoSave()"></label>
                <label>Bônus Mana da Classe: <input type="number" id="class_mana_bonus" value="0" min="0" onchange="calcularRecursos(); autoSave()"></label>
            </div>
            <div>
                <h3>Esforço</h3>
                <label>Esforço por Nível: <input type="number" id="effort_per_level" value="2" min="0" onchange="calcularRecursos(); autoSave()"></label>
                <label>Bônus Esforço da Raça: <input type="number" id="race_effort_bonus" value="0" min="0" onchange="calcularRecursos(); autoSave()"></label>
                <label>Bônus Esforço da Classe: <input type="number" id="class_effort_bonus" value="0" min="0" onchange="calcularRecursos(); autoSave()"></label>
            </div>
        </div>
    </div>

            <div class="section">
        <h2>4. Perícias</h2>
        
        <h3>💪 Perícias de Força</h3>
        <div class="two-columns">
            <label>Atletismo: 
                <input type="number" id="atletismo" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="atletismo_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('atletismo', 'for')" title="Rolar Atletismo">🎲</button>
            </label>
            <label>Luta (FOR): 
                <input type="number" id="luta_for" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="luta_for_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('luta_for', 'for')" title="Rolar Luta (FOR)">🎲</button>
            </label>
            <label>Mineração: 
                <input type="number" id="mineracao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="mineracao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('mineracao', 'for')" title="Rolar Mineração">🎲</button>
            </label>
        </div>

        <h3>🏃 Perícias de Destreza</h3>
        <div class="two-columns">
            <label>Fechadura: 
                <input type="number" id="fechadura" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="fechadura_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('fechadura', 'des')" title="Rolar Fechadura">🎲</button>
            </label>
            <label>Acrobacia: 
                <input type="number" id="acrobacia" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="acrobacia_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('acrobacia', 'des')" title="Rolar Acrobacia">🎲</button>
            </label>
            <label>Cavalgar: 
                <input type="number" id="cavalgar" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="cavalgar_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('cavalgar', 'des')" title="Rolar Cavalgar">🎲</button>
            </label>
            <label>Equilíbrio: 
                <input type="number" id="equilibrio" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="equilibrio_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('equilibrio', 'des')" title="Rolar Equilíbrio">🎲</button>
            </label>
            <label>Furtividade: 
                <input type="number" id="furtividade" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="furtividade_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('furtividade', 'des')" title="Rolar Furtividade">🎲</button>
            </label>
            <label>Luta (DES): 
                <input type="number" id="luta_des" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="luta_des_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('luta_des', 'des')" title="Rolar Luta (DES)">🎲</button>
            </label>
            <label>Prestidigitação: 
                <input type="number" id="prestidigitacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="prestidigitacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('prestidigitacao', 'des')" title="Rolar Prestidigitação">🎲</button>
            </label>
        </div>

        <h3>🧠 Perícias de Inteligência</h3>
        <div class="two-columns">
            <label>Alquimia: 
                <input type="number" id="alquimia" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="alquimia_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('alquimia', 'int')" title="Rolar Alquimia">🎲</button>
            </label>
            <label>Arcanismo: 
                <input type="number" id="arcanismo" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="arcanismo_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('arcanismo', 'int')" title="Rolar Arcanismo">🎲</button>
            </label>
            <label>Canalização: 
                <input type="number" id="canalizacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="canalizacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('canalizacao', 'int')" title="Rolar Canalização">🎲</button>
            </label>
            <label>Falsificação: 
                <input type="number" id="falsificacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="falsificacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('falsificacao', 'int')" title="Rolar Falsificação">🎲</button>
            </label>
            <label>Intuição: 
                <input type="number" id="intuicao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="intuicao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('intuicao', 'int')" title="Rolar Intuição">🎲</button>
            </label>
            <label>Investigação: 
                <input type="number" id="investigacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="investigacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('investigacao', 'int')" title="Rolar Investigação">🎲</button>
            </label>
            <label>Medicina: 
                <input type="number" id="medicina" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="medicina_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('medicina', 'int')" title="Rolar Medicina">🎲</button>
            </label>
            <label>Percepção: 
                <input type="number" id="percepcao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="percepcao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('percepcao', 'int')" title="Rolar Percepção">🎲</button>
            </label>
            <label>Sobrevivência: 
                <input type="number" id="sobrevivencia" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="sobrevivencia_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('sobrevivencia', 'int')" title="Rolar Sobrevivência">🎲</button>
            </label>
            <label>Vontade: 
                <input type="number" id="vontade" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="vontade_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('vontade', 'int')" title="Rolar Vontade">🎲</button>
            </label>
        </div>

        <h3>✨ Perícias de Carisma</h3>
        <div class="two-columns">
            <label>Adestrar: 
                <input type="number" id="adestrar" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="adestrar_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('adestrar', 'car')" title="Rolar Adestrar">🎲</button>
            </label>
            <label>Atuação: 
                <input type="number" id="atuacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="atuacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('atuacao', 'car')" title="Rolar Atuação">🎲</button>
            </label>
            <label>Diplomacia: 
                <input type="number" id="diplomacia" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="diplomacia_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('diplomacia', 'car')" title="Rolar Diplomacia">🎲</button>
            </label>
            <label>Enganação: 
                <input type="number" id="enganacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="enganacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('enganacao', 'car')" title="Rolar Enganação">🎲</button>
            </label>
            <label>Intimidação: 
                <input type="number" id="intimidacao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="intimidacao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('intimidacao', 'car')" title="Rolar Intimidação">🎲</button>
            </label>
            <label>Persuasão: 
                <input type="number" id="persuasao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="persuasao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('persuasao', 'car')" title="Rolar Persuasão">🎲</button>
            </label>
            <label>Sedução: 
                <input type="number" id="seducao" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="seducao_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('seducao', 'car')" title="Rolar Sedução">🎲</button>
            </label>
        </div>

        <h3>💚 Perícias de Constituição</h3>
        <div class="two-columns">
            <label>Fôlego: 
                <input type="number" id="folego" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="folego_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('folego', 'con')" title="Rolar Fôlego">🎲</button>
            </label>
            <label>Resistência ao Clima: 
                <input type="number" id="res_clima" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="res_clima_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('res_clima', 'con')" title="Rolar Resistência ao Clima">🎲</button>
            </label>
            <label>Resistência a Veneno: 
                <input type="number" id="res_veneno" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="res_veneno_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('res_veneno', 'con')" title="Rolar Resistência a Veneno">🎲</button>
            </label>
            <label>Resistência Física: 
                <input type="number" id="res_fisica" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="res_fisica_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('res_fisica', 'con')" title="Rolar Resistência Física">🎲</button>
            </label>
            <label>Resistência Mágica: 
                <input type="number" id="res_magica" value="0" min="0" max="15" onchange="atualizarPericias(); autoSave()">
                <span id="res_magica_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarPericia('res_magica', 'con')" title="Rolar Resistência Mágica">🎲</button>
            </label>
        </div>
    </div>

    <div class="section">
        <h2>5. Habilidades de Classe</h2>
        <button class="add-row-btn" onclick="adicionarHabilidade()">+ Adicionar Habilidade</button>
        <table id="habilidades-table">
            <thead>
                <tr>
                    <th>Nível</th><th>Habilidade</th><th>Descrição</th><th>Ações</th>
                </tr>
            </thead>
            <tbody id="habilidades-tbody">
                <tr>
                    <td><input type="number" class="hab-nivel" value="1" min="1" max="20" onchange="autoSave()"></td>
                    <td><input type="text" class="hab-nome" placeholder="Nome da habilidade" onchange="autoSave()"></td>
                    <td><input type="text" class="hab-desc" placeholder="Descrição da habilidade" onchange="autoSave()"></td>
                    <td><button class="remove-row-btn" onclick="removerLinha(this, 'habilidades')">×</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>6. Magias</h2>
        <div class="two-columns">
            <label>Escola Principal: <input type="text" id="escola_principal" placeholder="Ex: Evocação" onchange="autoSave()"></label>
            <label>Elemento Principal: <input type="text" id="elemento_principal" placeholder="Ex: Fogo" onchange="autoSave()"></label>
        </div>
        
        <button class="add-row-btn" onclick="adicionarMagia()">+ Adicionar Magia</button>
        <table id="magias-table">
            <thead>
                <tr>
                    <th>Nome</th><th>Nível</th><th>Escola</th><th>Elemento</th><th>Custo</th><th>Descrição</th><th>Ações</th>
                </tr>
            </thead>
            <tbody id="magias-tbody">
                <tr>
                    <td><input type="text" class="magia-nome" placeholder="Nome da magia" onchange="autoSave()"></td>
                    <td><input type="number" class="magia-nivel" value="1" min="1" max="9" onchange="autoSave()"></td>
                    <td><input type="text" class="magia-escola" placeholder="Escola" onchange="autoSave()"></td>
                    <td><input type="text" class="magia-elemento" placeholder="Elemento" onchange="autoSave()"></td>
                    <td><input type="text" class="magia-custo" placeholder="Custo MP" onchange="autoSave()"></td>
                    <td><input type="text" class="magia-desc" placeholder="Descrição" onchange="autoSave()"></td>
                    <td><button class="remove-row-btn" onclick="removerLinha(this, 'magias')">×</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>7. Equipamentos e Inventário</h2>
        
        <!-- Status de Peso -->
        <div id="peso-status" class="peso-status peso-normal">
            <strong>Peso: <span id="peso-atual">0</span> / <span id="peso-maximo">0</span> kg</strong>
            <div id="peso-descricao">Carga Normal</div>
        </div>
        
        <div class="two-columns">
            <label>Capacidade de Carga (Força × 5): <span id="capacidade_carga" class="attribute-total">0</span> kg</label>
            <label>Peso Total Atual: <span id="peso_total" class="attribute-total">0</span> kg</label>
        </div>

        <button class="add-row-btn" onclick="adicionarItem()">+ Adicionar Item</button>
        <table id="inventario-table">
            <thead>
                <tr>
                    <th>Item</th><th>Quantidade</th><th>Peso (kg)</th><th>Valor</th><th>Descrição</th><th>Ações</th>
                </tr>
            </thead>
            <tbody id="inventario-tbody">
                <tr>
                    <td><input type="text" class="item-nome" placeholder="Nome do item" onchange="autoSave(); calcularPeso()"></td>
                    <td><input type="number" class="item-qtd" value="1" min="1" onchange="autoSave(); calcularPeso()"></td>
                    <td><input type="number" class="item-peso" value="0" min="0" step="0.1" onchange="autoSave(); calcularPeso()"></td>
                    <td><input type="text" class="item-valor" placeholder="Valor" onchange="autoSave()"></td>
                    <td><input type="text" class="item-desc" placeholder="Descrição" onchange="autoSave()"></td>
                    <td><button class="remove-row-btn" onclick="removerLinha(this, 'inventario'); calcularPeso()">×</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>8. Combate</h2>
        <div class="two-columns">
            <label>Iniciativa: 
                <span id="iniciativa_total" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarIniciativa()" title="Rolar Iniciativa">🎲</button>
            </label>
            <label>Ataque Corpo a Corpo: 
                <span id="ataque_corpo" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarAtaque('corpo')" title="Rolar Ataque Corpo a Corpo">🎲</button>
            </label>
            <label>Ataque à Distância: 
                <span id="ataque_distancia" class="attribute-total">0</span>
                <button class="roll-btn" onclick="rolarAtaque('distancia')" title="Rolar Ataque à Distância">🎲</button>
            </label>
            <label>Classe de Armadura: <input type="number" id="ca" value="10" min="1" onchange="autoSave()"></label>
        </div>
        
        <h3>Ataques Especiais</h3>
        <button class="add-row-btn" onclick="adicionarAtaque()">+ Adicionar Ataque</button>
        <table id="ataques-table">
            <thead>
                <tr>
                    <th>Nome</th><th>Bônus</th><th>Dano</th><th>Tipo</th><th>Alcance</th><th>Descrição</th><th>Ações</th>
                </tr>
            </thead>
            <tbody id="ataques-tbody">
                <tr>
                    <td><input type="text" class="ataque-nome" placeholder="Nome do ataque" onchange="autoSave()"></td>
                    <td><input type="number" class="ataque-bonus" value="0" onchange="autoSave()"></td>
                    <td><input type="text" class="ataque-dano" placeholder="1d6" onchange="autoSave()"></td>
                    <td><input type="text" class="ataque-tipo" placeholder="Cortante" onchange="autoSave()"></td>
                    <td><input type="text" class="ataque-alcance" placeholder="Corpo a corpo" onchange="autoSave()"></td>
                    <td><input type="text" class="ataque-desc" placeholder="Descrição" onchange="autoSave()"></td>
                    <td><button class="remove-row-btn" onclick="removerLinha(this, 'ataques')">×</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>9. História e Personalidade</h2>
        <label>História: <textarea id="historia_personagem" rows="4" placeholder="História do personagem..." onchange="autoSave()"></textarea></label>
        <label>Personalidade: <textarea id="personalidade" rows="3" placeholder="Traços de personalidade..." onchange="autoSave()"></textarea></label>
        <label>Objetivos: <textarea id="objetivos" rows="3" placeholder="Objetivos do personagem..." onchange="autoSave()"></textarea></label>
        <label>Medos e Fraquezas: <textarea id="medos" rows="3" placeholder="Medos e fraquezas..." onchange="autoSave()"></textarea></label>
    </div>

    <div class="section">
        <h2>10. Anotações</h2>
        <textarea id="anotacoes" rows="6" placeholder="Anotações gerais, lembretes, etc..." onchange="autoSave()"></textarea>
    </div>
</div>

<!-- Modal de Dados Personalizados -->
<div id="modalDadoPersonalizado" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>🎲 Dados Personalizados</h3>
            <button class="modal-close" onclick="fecharDadoPersonalizado()">×</button>
        </div>
        
        <h4>Dados Rápidos:</h4>
        <div class="dado-grid">
            <button class="dado-preset" onclick="rolarDadoRapido('1d4')">d4</button>
            <button class="dado-preset" onclick="rolarDadoRapido('1d6')">d6</button>
            <button class="dado-preset" onclick="rolarDadoRapido('1d8')">d8</button>
            <button class="dado-preset" onclick="rolarDadoRapido('1d10')">d10</button>
            <button class="dado-preset" onclick="rolarDadoRapido('1d12')">d12</button>
            <button class="dado-preset" onclick="rolarDadoRapido('1d20')">d20</button>
            <button class="dado-preset" onclick="rolarDadoRapido('1d100')">d100</button>
            <button class="dado-preset" onclick="rolarDadoRapido('2d6')">2d6</button>
            <button class="dado-preset" onclick="rolarDadoRapido('3d6')">3d6</button>
        </div>
        
        <h4>Dados Customizados:</h4>
        <div class="input-group">
            <label>Quantidade: <input type="number" id="dadoQuantidade" value="1" min="1" max="20"></label>
            <label>Faces: <input type="number" id="dadoFaces" value="20" min="2" max="1000"></label>
            <label>Modificador: <input type="number" id="dadoModificador" value="0" min="-50" max="50"></label>
        </div>
        
        <div class="input-group">
            <label>Nome da Rolagem: <input type="text" id="dadoNome" placeholder="Ex: Dano de Fogo" style="width: 200px;"></label>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button class="btn-success" onclick="rolarDadoCustomizado()">🎲 Rolar</button>
            <button class="btn-danger" onclick="fecharDadoPersonalizado()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="firebase.js"></script>
<script src="auth.js"></script>

<script>
// ===== VARIÁVEIS GLOBAIS =====
let rollHistory = [];
let autoSaveTimer = null;
let fichaId = null;
let fichaData = {};

// ===== INICIALIZAÇÃO =====
document.addEventListener('DOMContentLoaded', function() {
    verificarAuth();
    inicializarFicha();
    atualizarTotais();
    calcularRecursos();
    atualizarPericias();
    calcularPeso();
});

// ===== SISTEMA DE ROLAGEM =====

// Função principal de rolagem
function rolarDado(faces = 20, modificador = 0, nome = 'Rolagem', detalhes = '') {
    const dado = Math.floor(Math.random() * faces) + 1;
    const total = dado + modificador;
    
    // Determinar tipo de resultado para d20
    let classe = '';
    let emoji = '🎲';
    let status = '';
    
    if (faces === 20) {
        if (dado === 20) {
            classe = 'critico-sucesso';
            emoji = '🌟';
            status = 'CRÍTICO!';
        } else if (dado === 1) {
            classe = 'critico-falha';
            emoji = '💀';
            status = 'FALHA CRÍTICA!';
        } else if (total >= 15) {
            classe = 'sucesso';
            emoji = '✅';
            status = 'Sucesso!';
        } else if (total <= 8) {
            emoji = '❌';
            status = 'Resultado baixo';
        }
    }
    
    // Adicionar ao histórico
    const roll = {
        nome: nome,
        dado: dado,
        modificador: modificador,
        total: total,
        faces: faces,
        timestamp: new Date(),
        classe: classe,
        emoji: emoji,
        status: status,
        detalhes: detalhes
    };
    
    rollHistory.unshift(roll);
    if (rollHistory.length > 20) rollHistory.pop();
    
    // Mostrar resultado
    mostrarResultado(roll);
    
    // Som de rolagem
    playRollSound();
    
    return roll;
}

// Rolar atributo (d20 + atributo total)
function rolarAtributo(atributo) {
    const nomes = {
        'for': 'Força',
        'des': 'Destreza',
        'con': 'Constituição',
        'int': 'Inteligência',
        'car': 'Carisma'
    };
    
    const total = parseInt(document.getElementById(`${atributo}_total`).textContent) || 1;
    const detalhes = `Atributo: ${total}`;
    
    rolarDado(20, total, `Teste de ${nomes[atributo]}`, detalhes);
}

// Rolar perícia (SISTEMA CORRETO: d20 + perícia + atributo)
function rolarPericia(pericia, atributoBase) {
    const nomePericia = pericia.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const valorPericia = parseInt(document.getElementById(pericia).value) || 0;
    const totalAtributo = parseInt(document.getElementById(`${atributoBase}_total`).textContent) || 1;
    
    const modificadorTotal = valorPericia + totalAtributo;
    const detalhes = `${nomePericia}: ${valorPericia} + ${atributoBase.toUpperCase()}: ${totalAtributo} = +${modificadorTotal}`;
    
    rolarDado(20, modificadorTotal, `${nomePericia}`, detalhes);
}

// Rolagens específicas
function rolarIniciativa() {
    const destreza = parseInt(document.getElementById('des_total').textContent) || 1;
    rolarDado(20, destreza, 'Iniciativa', `Destreza: ${destreza}`);
}

function rolarAtaque(tipo = 'corpo') {
    let atributo, nome;
    if (tipo === 'distancia') {
        atributo = parseInt(document.getElementById('des_total').textContent) || 1;
        nome = 'Ataque à Distância';
    } else {
        atributo = parseInt(document.getElementById('for_total').textContent) || 1;
        nome = 'Ataque Corpo a Corpo';
    }
    
    rolarDado(20, atributo, nome, `${tipo === 'distancia' ? 'Destreza' : 'Força'}: ${atributo}`);
}

function rolarDano(dados = '1d6') {
    const [num, faces] = dados.split('d').map(n => parseInt(n));
    let total = 0;
    let resultados = [];
    
    for (let i = 0; i < num; i++) {
        const resultado = Math.floor(Math.random() * faces) + 1;
        resultados.push(resultado);
        total += resultado;
    }
    
    const roll = {
        nome: 'Dano',
        dado: resultados.join(' + '),
        modificador: 0,
        total: total,
        faces: faces,
        timestamp: new Date(),
        classe: '',
        emoji: '⚔️',
        status: `${dados}`,
        detalhes: `Dados: [${resultados.join(', ')}]`
    };
    
    rollHistory.unshift(roll);
    mostrarResultado(roll);
    playRollSound();
}

// Mostrar resultado na tela
function mostrarResultado(roll) {
    // Remover resultado anterior se existir
    const existingResult = document.getElementById('rollResult');
    if (existingResult) {
        existingResult.remove();
    }
    
    // Criar novo resultado
    const resultDiv = document.createElement('div');
    resultDiv.id = 'rollResult';
    resultDiv.className = `roll-result ${roll.classe}`;
    
    resultDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong>${roll.nome}</strong>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; font-size: 1.2em; cursor: pointer;">×</button>
        </div>
        <div class="roll-result-numero">${roll.emoji} ${roll.total}</div>
        <div class="roll-result-detalhes">${roll.status}</div>
        <div class="roll-result-calculo">
            ${roll.detalhes}<br>
            <small>d${roll.faces}: ${roll.dado}${roll.modificador !== 0 ? ` + ${roll.modificador}` : ''}</small>
        </div>
    `;
    
    document.body.appendChild(resultDiv);
    
    // Mostrar com animação
    setTimeout(() => resultDiv.classList.add('show'), 100);
    
    // Auto-remover após 5 segundos
    setTimeout(() => {
        if (resultDiv.parentElement) {
            resultDiv.remove();
        }
    }, 5000);
    
    // Atualizar mini histórico
    atualizarMiniHistorico();
}

// ===== SISTEMA DE DADOS PERSONALIZADOS =====

function abrirDadoPersonalizado() {
    const modal = document.getElementById('modalDadoPersonalizado');
    modal.classList.add('show');
    
    // Focar no primeiro input
    setTimeout(() => {
        document.getElementById('dadoQuantidade').focus();
    }, 100);
}

function fecharDadoPersonalizado() {
    const modal = document.getElementById('modalDadoPersonalizado');
    modal.classList.remove('show');
}

function rolarDadoRapido(dados) {
    const [quantidade, faces] = dados.includes('d') ? 
        dados.split('d').map(n => parseInt(n)) : [1, parseInt(dados)];
    
    rolarDadosMultiplos(quantidade, faces, 0, `Rolagem ${dados}`);
    fecharDadoPersonalizado();
}

function rolarDadoCustomizado() {
    const quantidade = parseInt(document.getElementById('dadoQuantidade').value) || 1;
    const faces = parseInt(document.getElementById('dadoFaces').value) || 20;
    const modificador = parseInt(document.getElementById('dadoModificador').value) || 0;
    const nome = document.getElementById('dadoNome').value || `${quantidade}d${faces}`;
    
    rolarDadosMultiplos(quantidade, faces, modificador, nome);
    fecharDadoPersonalizado();
}

function rolarDadosMultiplos(quantidade, faces, modificador = 0, nome = 'Rolagem') {
    let total = 0;
    let resultados = [];
    
    // Rolar todos os dados
    for (let i = 0; i < quantidade; i++) {
        const resultado = Math.floor(Math.random() * faces) + 1;
        resultados.push(resultado);
        total += resultado;
    }
    
    // Adicionar modificador
    total += modificador;
    
    // Determinar tipo de resultado
    let classe = '';
    let emoji = '🎲';
    let status = '';
    
    if (faces === 20 && quantidade === 1) {
        if (resultados[0] === 20) {
            classe = 'critico-sucesso';
            emoji = '🌟';
            status = 'CRÍTICO!';
        } else if (resultados[0] === 1) {
            classe = 'critico-falha';
            emoji = '💀';
            status = 'FALHA CRÍTICA!';
        } else if (total >= 15) {
            classe = 'sucesso';
            emoji = '✅';
            status = 'Resultado Alto!';
        }
    } else if (total >= faces * quantidade * 0.8) {
        classe = 'sucesso';
        emoji = '✅';
        status = 'Resultado Alto!';
    } else if (total <= faces * quantidade * 0.2) {
        emoji = '❌';
        status = 'Resultado Baixo';
    }
    
    // Criar detalhes da rolagem
    let detalhes = `${quantidade}d${faces}`;
    if (quantidade > 1) {
        detalhes += `: [${resultados.join(', ')}]`;
        if (modificador !== 0) {
            detalhes += ` ${modificador >= 0 ? '+' : ''}${modificador}`;
        }
    } else if (modificador !== 0) {
        detalhes += ` ${modificador >= 0 ? '+' : ''}${modificador}`;
    }
    
    // Criar objeto de rolagem
    const roll = {
        nome: nome,
        dado: resultados.length > 1 ? resultados.join(' + ') : resultados[0],
        modificador: modificador,
        total: total,
        faces: faces,
        timestamp: new Date(),
        classe: classe,
        emoji: emoji,
        status: status,
        detalhes: detalhes
    };
    
    rollHistory.unshift(roll);
    if (rollHistory.length > 20) rollHistory.pop();
    
    // Mostrar resultado
    mostrarResultado(roll);
    
    // Som de rolagem
    playRollSound();
    
    return roll;
}

// Fechar modal ao clicar fora dele
document.addEventListener('click', function(e) {
    const modal = document.getElementById('modalDadoPersonalizado');
    if (e.target === modal) {
        fecharDadoPersonalizado();
    }
});

// Atalho de teclado para dados personalizados
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        abrirDadoPersonalizado();
    }
    
    // ESC para fechar modal
    if (e.key === 'Escape') {
        fecharDadoPersonalizado();
    }
});

// Mini histórico
function atualizarMiniHistorico() {
    let miniHistorico = document.getElementById('miniHistorico');
    
    if (!miniHistorico) {
        miniHistorico = document.createElement('div');
        miniHistorico.id = 'miniHistorico';
        miniHistorico.className = 'mini-historico';
        miniHistorico.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--cor-borda); padding-bottom: 5px;">
                <strong>🎲 Últimas Rolagens</strong>
                <button onclick="toggleMiniHistorico()" style="background: none; border: none; color: inherit; cursor: pointer;">×</button>
            </div>
            <div id="miniHistoricoContent"></div>
        `;
        document.body.appendChild(miniHistorico);
    }
    
    const content = document.getElementById('miniHistoricoContent');
    content.innerHTML = rollHistory.slice(0, 5).map(roll => {
        const tempo = roll.timestamp.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        return `
            <div class="mini-historico-item">
                <strong>${roll.emoji} ${roll.total}</strong> - ${roll.nome}
                <br><small>${tempo}</small>
            </div>
        `;
    }).join('');
}

function toggleMiniHistorico() {
    const miniHistorico = document.getElementById('miniHistorico');
    if (miniHistorico) {
        miniHistorico.classList.toggle('show');
    }
}

// Som de rolagem
function playRollSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 600 + Math.random() * 400;
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
    } catch (error) {
        // Ignorar se som não funcionar
    }
}

// ===== CÁLCULOS DA FICHA =====

function atualizarTotais() {
    const atributos = ['for', 'des', 'con', 'int', 'car'];
    
    atributos.forEach(attr => {
        const base = parseInt(document.getElementById(`${attr}_base`).value) || 1;
        const bonus = parseInt(document.getElementById(`${attr}_bonus`).value) || 0;
        const mod = parseInt(document.getElementById(`${attr}_mod`).value) || 0;
        const total = base + bonus + mod;
        
        document.getElementById(`${attr}_total`).textContent = total;
    });
    
    calcularRecursos();
    atualizarPericias();
    calcularCombate();
    calcularPeso();
}

function calcularRecursos() {
    const nivel = parseInt(document.getElementById('nivel').value) || 1;
    const con_total = parseInt(document.getElementById('con_total').textContent) || 1;
    const int_total = parseInt(document.getElementById('int_total').textContent) || 1;
    const for_total = parseInt(document.getElementById('for_total').textContent) || 1;
    
    // Vida
    const hpPerLevel = parseInt(document.getElementById('hp_per_level').value) || 5;
    const raceHpBonus = parseInt(document.getElementById('race_hp_bonus').value) || 0;
    const classHpBonus = parseInt(document.getElementById('class_hp_bonus').value) || 0;
    const vidaMax = (nivel * hpPerLevel) + con_total + raceHpBonus + classHpBonus;
    document.getElementById('vida_max').textContent = vidaMax;
    
    // Mana
    const manaPerLevel = parseInt(document.getElementById('mana_per_level').value) || 3;
    const raceManaBonus = parseInt(document.getElementById('race_mana_bonus').value) || 0;
    const classManaBonus = parseInt(document.getElementById('class_mana_bonus').value) || 0;
    const manaMax = (nivel * manaPerLevel) + int_total + raceManaBonus + classManaBonus;
    document.getElementById('mana_max').textContent = manaMax;
    
    // Esforço
    const effortPerLevel = parseInt(document.getElementById('effort_per_level').value) || 2;
    const raceEffortBonus = parseInt(document.getElementById('race_effort_bonus').value) || 0;
    const classEffortBonus = parseInt(document.getElementById('class_effort_bonus').value) || 0;
    const esforcoMax = (nivel * effortPerLevel) + con_total + raceEffortBonus + classEffortBonus;
    document.getElementById('esforco_max').textContent = esforcoMax;
    
    // Defesa
    const defesa = 10 + con_total;
    document.getElementById('defesa').textContent = defesa;
    
    // Capacidade de carga
    const capacidadeCarga = for_total * 5;
    document.getElementById('capacidade_carga').textContent = capacidadeCarga;
    document.getElementById('peso-maximo').textContent = capacidadeCarga;
}

function atualizarPericias() {
    // Atualizar totais das perícias (perícia + atributo)
    const pericias = [
        // Força
        {nome: 'atletismo', attr: 'for'},
        {nome: 'luta_for', attr: 'for'},
        {nome: 'mineracao', attr: 'for'},
        
        // Destreza
        {nome: 'fechadura', attr: 'des'},
        {nome: 'acrobacia', attr: 'des'},
        {nome: 'cavalgar', attr: 'des'},
        {nome: 'equilibrio', attr: 'des'},
        {nome: 'furtividade', attr: 'des'},
        {nome: 'luta_des', attr: 'des'},
        {nome: 'prestidigitacao', attr: 'des'},
        
        // Inteligência
        {nome: 'alquimia', attr: 'int'},
        {nome: 'arcanismo', attr: 'int'},
        {nome: 'canalizacao', attr: 'int'},
        {nome: 'falsificacao', attr: 'int'},
        {nome: 'intuicao', attr: 'int'},
        {nome: 'investigacao', attr: 'int'},
        {nome: 'medicina', attr: 'int'},
        {nome: 'percepcao', attr: 'int'},
        {nome: 'sobrevivencia', attr: 'int'},
        {nome: 'vontade', attr: 'int'},
        
        // Carisma
        {nome: 'adestrar', attr: 'car'},
        {nome: 'atuacao', attr: 'car'},
        {nome: 'diplomacia', attr: 'car'},
        {nome: 'enganacao', attr: 'car'},
        {nome: 'intimidacao', attr: 'car'},
        {nome: 'persuasao', attr: 'car'},
        {nome: 'seducao', attr: 'car'},
        
        // Constituição
        {nome: 'folego', attr: 'con'},
        {nome: 'res_clima', attr: 'con'},
        {nome: 'res_veneno', attr: 'con'},
        {nome: 'res_fisica', attr: 'con'},
        {nome: 'res_magica', attr: 'con'}
    ];
    
    pericias.forEach(pericia => {
        const valorPericia = parseInt(document.getElementById(pericia.nome).value) || 0;
        const valorAtributo = parseInt(document.getElementById(`${pericia.attr}_total`).textContent) || 1;
        const total = valorPericia + valorAtributo;
        
        const totalElement = document.getElementById(`${pericia.nome}_total`);
        if (totalElement) {
            totalElement.textContent = total;
        }
    });
}

function calcularCombate() {
    const des_total = parseInt(document.getElementById('des_total').textContent) || 1;
    const for_total = parseInt(document.getElementById('for_total').textContent) || 1;
    
    document.getElementById('iniciativa_total').textContent = des_total;
    document.getElementById('ataque_corpo').textContent = for_total;
    document.getElementById('ataque_distancia').textContent = des_total;
}

// ===== SISTEMA DE PESO =====

function calcularPeso() {
    let pesoTotal = 0;
    const itens = document.querySelectorAll('#inventario-tbody tr');
    
    itens.forEach(item => {
        const quantidade = parseInt(item.querySelector('.item-qtd')?.value) || 0;
        const peso = parseFloat(item.querySelector('.item-peso')?.value) || 0;
        pesoTotal += quantidade * peso;
    });
    
    document.getElementById('peso_total').textContent = pesoTotal.toFixed(1);
    document.getElementById('peso-atual').textContent = pesoTotal.toFixed(1);
    
    // Calcular status do peso
    const pesoMaximo = parseInt(document.getElementById('capacidade_carga').textContent) || 0;
    const pesoStatus = document.getElementById('peso-status');
    
    if (pesoTotal <= pesoMaximo * 0.5) {
        pesoStatus.className = 'peso-status peso-normal';
        document.getElementById('peso-descricao').textContent = 'Carga Normal';
    } else if (pesoTotal <= pesoMaximo * 0.75) {
        pesoStatus.className = 'peso-status peso-sobrecarregado';
        document.getElementById('peso-descricao').textContent = 'Carga Pesada (-2 em testes de agilidade)';
    } else if (pesoTotal <= pesoMaximo) {
        pesoStatus.className = 'peso-status peso-sobrecarregado';
        document.getElementById('peso-descricao').textContent = 'Sobrecarregado (-4 em testes de agilidade)';
    } else {
        pesoStatus.className = 'peso-status peso-maximo';
        document.getElementById('peso-descricao').textContent = 'Peso Máximo Excedido! (Não pode se mover)';
    }
}

// ===== TABELAS EXPANSÍVEIS =====

function adicionarHabilidade() {
    const tbody = document.getElementById('habilidades-tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="number" class="hab-nivel" value="1" min="1" max="20" onchange="autoSave()"></td>
        <td><input type="text" class="hab-nome" placeholder="Nome da habilidade" onchange="autoSave()"></td>
        <td><input type="text" class="hab-desc" placeholder="Descrição da habilidade" onchange="autoSave()"></td>
        <td><button class="remove-row-btn" onclick="removerLinha(this, 'habilidades')">×</button></td>
    `;
    tbody.appendChild(newRow);
}

function adicionarMagia() {
    const tbody = document.getElementById('magias-tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" class="magia-nome" placeholder="Nome da magia" onchange="autoSave()"></td>
        <td><input type="number" class="magia-nivel" value="1" min="1" max="9" onchange="autoSave()"></td>
        <td><input type="text" class="magia-escola" placeholder="Escola" onchange="autoSave()"></td>
        <td><input type="text" class="magia-elemento" placeholder="Elemento" onchange="autoSave()"></td>
        <td><input type="text" class="magia-custo" placeholder="Custo MP" onchange="autoSave()"></td>
        <td><input type="text" class="magia-desc" placeholder="Descrição" onchange="autoSave()"></td>
        <td><button class="remove-row-btn" onclick="removerLinha(this, 'magias')">×</button></td>
    `;
    tbody.appendChild(newRow);
}

function adicionarItem() {
    const tbody = document.getElementById('inventario-tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" class="item-nome" placeholder="Nome do item" onchange="autoSave(); calcularPeso()"></td>
        <td><input type="number" class="item-qtd" value="1" min="1" onchange="autoSave(); calcularPeso()"></td>
        <td><input type="number" class="item-peso" value="0" min="0" step="0.1" onchange="autoSave(); calcularPeso()"></td>
        <td><input type="text" class="item-valor" placeholder="Valor" onchange="autoSave()"></td>
        <td><input type="text" class="item-desc" placeholder="Descrição" onchange="autoSave()"></td>
        <td><button class="remove-row-btn" onclick="removerLinha(this, 'inventario'); calcularPeso()">×</button></td>
    `;
    tbody.appendChild(newRow);
}

function adicionarAtaque() {
    const tbody = document.getElementById('ataques-tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" class="ataque-nome" placeholder="Nome do ataque" onchange="autoSave()"></td>
        <td><input type="number" class="ataque-bonus" value="0" onchange="autoSave()"></td>
        <td><input type="text" class="ataque-dano" placeholder="1d6" onchange="autoSave()"></td>
        <td><input type="text" class="ataque-tipo" placeholder="Cortante" onchange="autoSave()"></td>
        <td><input type="text" class="ataque-alcance" placeholder="Corpo a corpo" onchange="autoSave()"></td>
        <td><input type="text" class="ataque-desc" placeholder="Descrição" onchange="autoSave()"></td>
        <td><button class="remove-row-btn" onclick="removerLinha(this, 'ataques')">×</button></td>
    `;
    tbody.appendChild(newRow);
}

function removerLinha(button, tipo) {
    const row = button.closest('tr');
    const tbody = row.parentNode;
    
    // Não permitir remover se for a única linha
    if (tbody.children.length > 1) {
        row.remove();
        autoSave();
        
        if (tipo === 'inventario') {
            calcularPeso();
        }
    } else {
        alert('Não é possível remover a última linha.');
    }
}

// ===== VALIDAÇÕES =====

function validarVidaAtual() {
    const vidaAtual = parseInt(document.getElementById('vida_atual').value);
    const vidaMax = parseInt(document.getElementById('vida_max').textContent);
    
    if (vidaAtual > vidaMax) {
        document.getElementById('vida_atual').value = vidaMax;
    }
}

function validarManaAtual() {
    const manaAtual = parseInt(document.getElementById('mana_atual').value);
    const manaMax = parseInt(document.getElementById('mana_max').textContent);
    
    if (manaAtual > manaMax) {
        document.getElementById('mana_atual').value = manaMax;
    }
}

function validarEsforcoAtual() {
    const esforcoAtual = parseInt(document.getElementById('esforco_atual').value);
    const esforcoMax = parseInt(document.getElementById('esforco_max').textContent);
    
    if (esforcoAtual > esforcoMax) {
        document.getElementById('esforco_atual').value = esforcoMax;
    }
}

// ===== SISTEMA DE SALVAMENTO =====

function autoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    autoSaveTimer = setTimeout(() => {
        salvarFicha();
    }, 1000); // Salva após 1 segundo de inatividade
}

function salvarFicha() {
    if (!fichaId) return;
    
    const fichaData = coletarDadosFicha();
    
    // Mostrar status de salvamento
    mostrarSyncStatus('Salvando...', false);
    
    // Salvar no Firebase
    db.collection('fichas').doc(fichaId).set(fichaData)
        .then(() => {
            mostrarSyncStatus('Salvo!', false);
            setTimeout(() => {
                document.getElementById('syncStatus').classList.remove('show');
            }, 2000);
        })
        .catch((error) => {
            console.error('Erro ao salvar:', error);
            mostrarSyncStatus('Erro ao salvar!', true);
        });
}

function coletarDadosFicha() {
    const data = {
        // Informações básicas
        nome: document.getElementById('nome').value,
        jogador: document.getElementById('jogador').value,
        raca: document.getElementById('raca').value,
        tribo: document.getElementById('tribo').value,
        classe: document.getElementById('classe').value,
        nivel: document.getElementById('nivel').value,
        xp: document.getElementById('xp').value,
        
        // Atributos
        for_base: document.getElementById('for_base').value,
        for_bonus: document.getElementById('for_bonus').value,
        for_mod: document.getElementById('for_mod').value,
        des_base: document.getElementById('des_base').value,
        des_bonus: document.getElementById('des_bonus').value,
        des_mod: document.getElementById('des_mod').value,
        con_base: document.getElementById('con_base').value,
        con_bonus: document.getElementById('con_bonus').value,
        con_mod: document.getElementById('con_mod').value,
        int_base: document.getElementById('int_base').value,
        int_bonus: document.getElementById('int_bonus').value,
        int_mod: document.getElementById('int_mod').value,
        car_base: document.getElementById('car_base').value,
        car_bonus: document.getElementById('car_bonus').value,
        car_mod: document.getElementById('car_mod').value,
        
        // Recursos
        vida_atual: document.getElementById('vida_atual').value,
        mana_atual: document.getElementById('mana_atual').value,
        esforco_atual: document.getElementById('esforco_atual').value,
        hp_per_level: document.getElementById('hp_per_level').value,
        race_hp_bonus: document.getElementById('race_hp_bonus').value,
        class_hp_bonus: document.getElementById('class_hp_bonus').value,
        mana_per_level: document.getElementById('mana_per_level').value,
        race_mana_bonus: document.getElementById('race_mana_bonus').value,
        class_mana_bonus: document.getElementById('class_mana_bonus').value,
        effort_per_level: document.getElementById('effort_per_level').value,
        race_effort_bonus: document.getElementById('race_effort_bonus').value,
        class_effort_bonus: document.getElementById('class_effort_bonus').value,
        
        // Perícias
        atletismo: document.getElementById('atletismo').value,
        intimidacao: document.getElementById('intimidacao').value,
        acrobacia: document.getElementById('acrobacia').value,
        furtividade: document.getElementById('furtividade').value,
        prestidigitacao: document.getElementById('prestidigitacao').value,
        pontaria: document.getElementById('pontaria').value,
        resistencia: document.getElementById('resistencia').value,
        sobrevivencia: document.getElementById('sobrevivencia').value,
        investigacao: document.getElementById('investigacao').value,
        historia: document.getElementById('historia').value,
        medicina: document.getElementById('medicina').value,
        natureza: document.getElementById('natureza').value,
        persuasao: document.getElementById('persuasao').value,
        enganacao: document.getElementById('enganacao').value,
        performance: document.getElementById('performance').value,
        percepcao: document.getElementById('percepcao').value,
        
        // Magias
        escola_principal: document.getElementById('escola_principal').value,
        elemento_principal: document.getElementById('elemento_principal').value,
        
        // Combate
        ca: document.getElementById('ca').value,
        
        // História
        historia_personagem: document.getElementById('historia_personagem').value,
        personalidade: document.getElementById('personalidade').value,
        objetivos: document.getElementById('objetivos').value,
        medos: document.getElementById('medos').value,
        anotacoes: document.getElementById('anotacoes').value,
        
        // Tabelas expansíveis
        habilidades: coletarTabelaHabilidades(),
        magias: coletarTabelaMagias(),
        inventario: coletarTabelaInventario(),
        ataques: coletarTabelaAtaques(),
        
        // Timestamp
        lastModified: new Date().toISOString()
    };
    
    return data;
}

function coletarTabelaHabilidades() {
    const rows = document.querySelectorAll('#habilidades-tbody tr');
    const habilidades = [];
    
    rows.forEach(row => {
        const nivel = row.querySelector('.hab-nivel')?.value;
        const nome = row.querySelector('.hab-nome')?.value;
        const desc = row.querySelector('.hab-desc')?.value;
        
        if (nome) {
            habilidades.push({ nivel, nome, desc });
        }
    });
    
    return habilidades;
}

function coletarTabelaMagias() {
    const rows = document.querySelectorAll('#magias-tbody tr');
    const magias = [];
    
    rows.forEach(row => {
        const nome = row.querySelector('.magia-nome')?.value;
        const nivel = row.querySelector('.magia-nivel')?.value;
        const escola = row.querySelector('.magia-escola')?.value;
        const elemento = row.querySelector('.magia-elemento')?.value;
        const custo = row.querySelector('.magia-custo')?.value;
        const desc = row.querySelector('.magia-desc')?.value;
        
        if (nome) {
            magias.push({ nome, nivel, escola, elemento, custo, desc });
        }
    });
    
    return magias;
}

function coletarTabelaInventario() {
    const rows = document.querySelectorAll('#inventario-tbody tr');
    const inventario = [];
    
    rows.forEach(row => {
        const nome = row.querySelector('.item-nome')?.value;
        const qtd = row.querySelector('.item-qtd')?.value;
        const peso = row.querySelector('.item-peso')?.value;
        const valor = row.querySelector('.item-valor')?.value;
        const desc = row.querySelector('.item-desc')?.value;
        
        if (nome) {
            inventario.push({ nome, qtd, peso, valor, desc });
        }
    });
    
    return inventario;
}

function coletarTabelaAtaques() {
    const rows = document.querySelectorAll('#ataques-tbody tr');
    const ataques = [];
    
    rows.forEach(row => {
        const nome = row.querySelector('.ataque-nome')?.value;
        const bonus = row.querySelector('.ataque-bonus')?.value;
        const dano = row.querySelector('.ataque-dano')?.value;
        const tipo = row.querySelector('.ataque-tipo')?.value;
        const alcance = row.querySelector('.ataque-alcance')?.value;
        const desc = row.querySelector('.ataque-desc')?.value;
        
        if (nome) {
            ataques.push({ nome, bonus, dano, tipo, alcance, desc });
        }
    });
    
    return ataques;
}

function mostrarSyncStatus(texto, isError) {
    const syncStatus = document.getElementById('syncStatus');
    const syncText = document.getElementById('syncText');
    
    syncText.textContent = texto;
    syncStatus.className = `sync-status show ${isError ? 'error' : ''}`;
}

// ===== INICIALIZAÇÃO E CARREGAMENTO =====

function inicializarFicha() {
    const urlParams = new URLSearchParams(window.location.search);
    fichaId = urlParams.get('id');
    
    if (fichaId) {
        carregarFicha(fichaId);
    } else {
        // Criar nova ficha
        criarNovaFicha();
    }
}

function carregarFicha(id) {
    db.collection('fichas').doc(id).get()
        .then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                preencherFicha(data);
                document.getElementById('tituloFicha').textContent = `Ficha: ${data.nome || 'Personagem'}`;
            } else {
                console.log('Ficha não encontrada');
                criarNovaFicha();
            }
        })
        .catch((error) => {
            console.error('Erro ao carregar ficha:', error);
        });
}

function preencherFicha(data) {
    // Preencher campos básicos
    Object.keys(data).forEach(key => {
        const element = document.getElementById(key);
        if (element && typeof data[key] !== 'object') {
            element.value = data[key];
        }
    });
    
    // Preencher tabelas expansíveis
    if (data.habilidades) {
        preencherTabelaHabilidades(data.habilidades);
    }
    
    if (data.magias) {
        preencherTabelaMagias(data.magias);
    }
    
    if (data.inventario) {
        preencherTabelaInventario(data.inventario);
    }
    
    if (data.ataques) {
        preencherTabelaAtaques(data.ataques);
    }
    
    // Recalcular tudo
    atualizarTotais();
}

function preencherTabelaHabilidades(habilidades) {
    const tbody = document.getElementById('habilidades-tbody');
    tbody.innerHTML = '';
    
    habilidades.forEach(hab => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="number" class="hab-nivel" value="${hab.nivel}" min="1" max="20" onchange="autoSave()"></td>
            <td><input type="text" class="hab-nome" value="${hab.nome}" placeholder="Nome da habilidade" onchange="autoSave()"></td>
            <td><input type="text" class="hab-desc" value="${hab.desc}" placeholder="Descrição da habilidade" onchange="autoSave()"></td>
            <td><button class="remove-row-btn" onclick="removerLinha(this, 'habilidades')">×</button></td>
        `;
        tbody.appendChild(row);
    });
    
    // Garantir pelo menos uma linha
    if (tbody.children.length === 0) {
        adicionarHabilidade();
    }
}

function preencherTabelaMagias(magias) {
    const tbody = document.getElementById('magias-tbody');
    tbody.innerHTML = '';
    
    magias.forEach(magia => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="magia-nome" value="${magia.nome}" placeholder="Nome da magia" onchange="autoSave()"></td>
            <td><input type="number" class="magia-nivel" value="${magia.nivel}" min="1" max="9" onchange="autoSave()"></td>
            <td><input type="text" class="magia-escola" value="${magia.escola}" placeholder="Escola" onchange="autoSave()"></td>
            <td><input type="text" class="magia-elemento" value="${magia.elemento}" placeholder="Elemento" onchange="autoSave()"></td>
            <td><input type="text" class="magia-custo" value="${magia.custo}" placeholder="Custo MP" onchange="autoSave()"></td>
            <td><input type="text" class="magia-desc" value="${magia.desc}" placeholder="Descrição" onchange="autoSave()"></td>
            <td><button class="remove-row-btn" onclick="removerLinha(this, 'magias')">×</button></td>
        `;
        tbody.appendChild(row);
    });
    
    // Garantir pelo menos uma linha
    if (tbody.children.length === 0) {
        adicionarMagia();
    }
}

function preencherTabelaInventario(inventario) {
    const tbody = document.getElementById('inventario-tbody');
    tbody.innerHTML = '';
    
    inventario.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="item-nome" value="${item.nome}" placeholder="Nome do item" onchange="autoSave(); calcularPeso()"></td>
            <td><input type="number" class="item-qtd" value="${item.qtd}" min="1" onchange="autoSave(); calcularPeso()"></td>
            <td><input type="number" class="item-peso" value="${item.peso}" min="0" step="0.1" onchange="autoSave(); calcularPeso()"></td>
            <td><input type="text" class="item-valor" value="${item.valor}" placeholder="Valor" onchange="autoSave()"></td>
            <td><input type="text" class="item-desc" value="${item.desc}" placeholder="Descrição" onchange="autoSave()"></td>
            <td><button class="remove-row-btn" onclick="removerLinha(this, 'inventario'); calcularPeso()">×</button></td>
        `;
        tbody.appendChild(row);
    });
    
    // Garantir pelo menos uma linha
    if (tbody.children.length === 0) {
        adicionarItem();
    }
}

function preencherTabelaAtaques(ataques) {
    const tbody = document.getElementById('ataques-tbody');
    tbody.innerHTML = '';
    
    ataques.forEach(ataque => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="ataque-nome" value="${ataque.nome}" placeholder="Nome do ataque" onchange="autoSave()"></td>
            <td><input type="number" class="ataque-bonus" value="${ataque.bonus}" onchange="autoSave()"></td>
            <td><input type="text" class="ataque-dano" value="${ataque.dano}" placeholder="1d6" onchange="autoSave()"></td>
            <td><input type="text" class="ataque-tipo" value="${ataque.tipo}" placeholder="Cortante" onchange="autoSave()"></td>
            <td><input type="text" class="ataque-alcance" value="${ataque.alcance}" placeholder="Corpo a corpo" onchange="autoSave()"></td>
            <td><input type="text" class="ataque-desc" value="${ataque.desc}" placeholder="Descrição" onchange="autoSave()"></td>
            <td><button class="remove-row-btn" onclick="removerLinha(this, 'ataques')">×</button></td>
        `;
        tbody.appendChild(row);
    });
    
    // Garantir pelo menos uma linha
    if (tbody.children.length === 0) {
        adicionarAtaque();
    }
}

function criarNovaFicha() {
    const novaFichaData = {
        nome: '',
        jogador: firebase.auth().currentUser?.email || '',
        userId: firebase.auth().currentUser?.uid,
        created: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    db.collection('fichas').add(novaFichaData)
        .then((docRef) => {
            fichaId = docRef.id;
            // Atualizar URL sem recarregar a página
            window.history.replaceState(null, null, `?id=${fichaId}`);
        })
        .catch((error) => {
            console.error('Erro ao criar ficha:', error);
        });
}

// ===== FUNÇÕES DE NAVEGAÇÃO =====

function voltarAoHub() {
    window.location.href = 'hub.html';
}

function abrirRegras() {
    window.open('regras.html', '_blank');
}

function exportarFicha() {
    const data = coletarDadosFicha();
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `ficha_${data.nome || 'personagem'}.json`;
    link.click();
}

function compartilharFicha() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('Link da ficha copiado para a área de transferência!');
    });
}

function verificarAuth() {
    firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
            window.location.href = 'login.html';
        }
    });
}

function logout() {
    firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
    });
}

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        switch(e.key) {
            case 'r':
                e.preventDefault();
                rolarDado(20, 0, 'Rolagem Rápida');
                break;
            case 'i':
                e.preventDefault();
                rolarIniciativa();
                break;
            case 'a':
                e.preventDefault();
                rolarAtaque('corpo');
                break;
            case 's':
                e.preventDefault();
                salvarFicha();
                break;
        }
    }
});

// ===== SISTEMA DE CHAT SIMPLES =====
let chatAberto = false;
let ultimaMensagem = 0;

function debugLog(message, data = null) {
    console.log(`[CHAT DEBUG] ${message}`, data);
}

function toggleChat() {
    const container = document.getElementById('chatContainer');
    const toggleBtn = document.getElementById('chatToggleBtn');
    
    if (!container || !toggleBtn) return;
    
    chatAberto = !chatAberto;
    
    if (chatAberto) {
        container.classList.add('show');
        toggleBtn.style.display = 'none';
    } else {
        container.classList.remove('show');
        toggleBtn.style.display = 'flex';
    }
}

function enviarMensagem() {
    debugLog('=== ENVIANDO MENSAGEM ===');
    
    const input = document.getElementById('chatInput');
    if (!input) return;
    
    const mensagem = input.value.trim();
    if (!mensagem) return;
    
    // Aguardar Firebase estar disponível
    setTimeout(function() {
        try {
            if (!window.firebase) {
                alert('Firebase não carregado');
                return;
            }
            
            const user = firebase.auth().currentUser;
            if (!user) {
                alert('Você precisa estar logado!');
                return;
            }
            
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            firebase.database().ref('chat/mesa_principal/mensagens').push({
                userId: user.uid,
                userName: userData.displayName || user.email.split('@')[0],
                userRole: userData.role || 'player',
                message: mensagem,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                type: 'text'
            }).then(() => {
                input.value = '';
                debugLog('✅ Mensagem enviada!');
            }).catch(error => {
                debugLog('❌ Erro:', error);
                alert('Erro: ' + error.message);
            });
            
        } catch (error) {
            alert('Erro no Firebase: ' + error.message);
        }
    }, 100);
}

function escutarMensagens() {
    setTimeout(function() {
        try {
            if (!window.firebase) return;
            
            const chatRef = firebase.database().ref('chat/mesa_principal/mensagens');
            
            chatRef.orderByChild('timestamp').limitToLast(50).on('child_added', function(snapshot) {
                const mensagem = snapshot.val();
                
                if (mensagem.timestamp > ultimaMensagem) {
                    adicionarMensagemNoChat(mensagem);
                    ultimaMensagem = mensagem.timestamp;
                }
            });
            
        } catch (error) {
            console.error('Erro ao escutar mensagens:', error);
        }
    }, 2000);
}

function adicionarMensagemNoChat(mensagem) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const currentUser = firebase.auth().currentUser;
    const messageDiv = document.createElement('div');
    const isOwn = mensagem.userId === currentUser.uid;
    const isMaster = mensagem.userRole === 'master';
    
    let messageClass = 'chat-message ';
    if (mensagem.type === 'dice') {
        messageClass += 'dice';
    } else if (isOwn) {
        messageClass += 'own';
    } else if (isMaster) {
        messageClass += 'master';
    } else {
        messageClass += 'other';
    }
    
    messageDiv.className = messageClass;
    
    const timestamp = new Date(mensagem.timestamp);
    const timeString = timestamp.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-user ${isOwn ? 'own' : (isMaster ? 'master' : '')}">${mensagem.userName}</span>
            <span class="message-time">${timeString}</span>
        </div>
        <div class="message-text">${mensagem.message}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll para baixo
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function marcarUsuarioOnline() {
    setTimeout(function() {
        try {
            if (!window.firebase) return;
            
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            const userOnlineRef = firebase.database().ref(`chat/mesa_principal/usuarios_online/${user.uid}`);
            
            userOnlineRef.set({
                userId: user.uid,
                userName: userData.displayName || user.email.split('@')[0],
                userRole: userData.role || 'player',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            userOnlineRef.onDisconnect().remove();
            
        } catch (error) {
            console.error('Erro ao marcar usuário online:', error);
        }
    }, 2000);
}

function inicializarChatSimples() {
    debugLog('Inicializando chat...');
    
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                enviarMensagem();
            }
        });
    }
    
    marcarUsuarioOnline();
    escutarMensagens();
}

// Tentar inicializar várias vezes
setTimeout(() => inicializarChatSimples(), 3000);
setTimeout(() => inicializarChatSimples(), 5000);
setTimeout(() => inicializarChatSimples(), 7000);

// Atalho
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        toggleChat();
    }
});

debugLog('Sistema de chat carregado!');

</script>

<!-- Chat Toggle Button -->
<button id="chatToggleBtn" class="chat-toggle-btn" onclick="toggleChat()" title="Chat do RPG">
    💬
    <span id="onlineCount" class="online-indicator" style="display: none;">0</span>
</button>

<!-- Chat Container -->
<div id="chatContainer" class="chat-container">
    <div class="chat-header">
        <div class="chat-title">🎲 Chat da Mesa</div>
        <button class="chat-toggle" onclick="toggleChat()">−</button>
    </div>
    
    <div id="chatMessages" class="chat-messages">
        <div class="chat-message system">
            <div class="message-text">Bem-vindo ao chat da mesa de RPG!</div>
        </div>
    </div>
    
    <div class="chat-input-container">
        <div class="chat-input-group">
            <input type="text" id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." maxlength="500">
            <button id="chatSend" class="chat-send" onclick="enviarMensagem()">📤</button>
        </div>
    </div>
</div>

</body>
</html>
